<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Lomogram</title>
<style>
html {
  display: table;
  width: 100%;
  height: 100%;
}
body {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
  margin: 0;
  font-size: 0;
}
noscript {
  font-size: 1em;
}
canvas {
  cursor: crosshair;
}
</style>
<script src="darkroom.js"></script>
<script>
'use strict';

function init() {
  var canvas = document.getElementById('canvas');
  canvas.addEventListener('click', lomo, false);
  //canvas.addEventListener('dragover',)
  //canvas.addEventListener('drop')
  
  load('sf.png');
}

function load(src) {
  var image = new Image;
  image.onload = function() {
    draw(this);
  };
  image.src = src;
}

function draw(image) {
  var canvas = document.getElementById('canvas');
  canvas.width = image.naturalWidth;
  canvas.height = image.naturalHeight;
  var context = canvas.getContext('2d');
  context.drawImage(image, 0, 0);
  canvas.image = image;
}

function lomo() {
  var canvas = document.getElementById('canvas');
  if (!canvas.image)
    return;

  var context = canvas.getContext('2d');
  context.drawImage(canvas.image, 0, 0);

  canvas.lomo = !canvas.lomo;
  // XXX hack for vignette
  canvas.style.backgroundColor = canvas.lomo ? '#000' : '';
  if (!canvas.lomo)
    return;

  var pxls = context.getImageData(0, 0, canvas.width, canvas.height);
  
  // apply basic filters
  ProcessImageData(pxls, { contrast: 1.2, saturation: 1.2, temperature: 300 });

  // so-so vignette
  var w = canvas.width, h = canvas.height, row, col, i;
  for (row = 0; row < h; row++) {
    for (col = 0; col < w; col++) {
      pxls.data[(row * w + col) * 4 + 3] =
        (1 - Math.pow((col - w / 2) / w * 2, 4)) *
        (1 - Math.pow((row - h / 2) / h * 2, 4)) *
        255 + 16;
    }
  }
  
  context.putImageData(pxls, 0, 0);
}

window.addEventListener('load', init, false);
</script>
</head>
<body>
<noscript>
  For full functionality of this site, it is necessary to enable JavaScript.
  Here are the <a href="http://enable-javascript.com" target="_blank">
  instructions on how to enable JavaScript in your web browser</a>.
</noscript>
<canvas id="canvas"></canvas>
<div></div>
</body>
</html>
