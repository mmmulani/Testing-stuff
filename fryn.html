<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1" />
<title>Lomogram</title>
<style>
html {
  display: table;
  width: 100%;
  height: 100%;
}
body {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
  margin: 0;
  font-size: 0;
}
noscript {
  font-size: 1em;
}
</style>
<script>
'use strict';

var src = 'suzhou.jpg';

function load() {
  var image = new Image;
  image.onload = function() {
    draw(this);
    window.addEventListener('mousemove', lomo, false);
    //lomo();
  };
  image.src = src;
}

function draw(image) {
  var canvas = document.getElementById('canvas');
  canvas.width = image.naturalWidth;
  canvas.height = image.naturalHeight;
  var context = canvas.getContext('2d');
  context.drawImage(image, 0, 0);
}

function lomo(event) {
  if (window.drawing)
    return;
  window.drawing = true;
  var multiplier = event.clientX / innerWidth * 2;
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  if (!window.orig)
    window.orig = context.getImageData(0, 0, canvas.width, canvas.height);
  var pxls = context.createImageData(canvas.width, canvas.height);
  var row, col, i;
  window.drawing = true;
  for (row = 0; row < canvas.height; row++) {
    for (col = 0; col < canvas.width; col++) {
      i = row * canvas.width * 4 + col * 4;
      pxls.data[i + 0] = ~~Math.min(255, orig.data[i + 0] * multiplier);
      pxls.data[i + 1] = ~~Math.min(255, orig.data[i + 1] * multiplier);
      pxls.data[i + 2] = ~~Math.min(255, orig.data[i + 2] * multiplier);
      pxls.data[i + 3] = 255;
    }
  }
  context.putImageData(pxls, 0, 0);
  window.drawing = false;
}

window.addEventListener('load', load, false);
</script>
</head>
<body>
<noscript>
  For full functionality of this site, it is necessary to enable JavaScript.
  Here are the <a href="http://enable-javascript.com" target="_blank">
  instructions on how to enable JavaScript in your web browser</a>.
</noscript>
<canvas id="canvas"></canvas>
<div></div>
</body>
</html>
