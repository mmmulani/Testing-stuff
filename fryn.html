<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Lomogram</title>
<style>
html {
  display: table;
  width: 100%;
  height: 100%;
}
body {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
  margin: 0;
  font-size: 0;
}
noscript {
  font-size: 1em;
}
canvas {
  cursor: crosshair;
}
</style>
<script src="darkroom.js"></script>
<script>
'use strict';

var MAX_FILE_SIZE = 2 * 1048576; // 2 MB

function init() {
  var canvas = document.getElementById('canvas');
  canvas.addEventListener('click', lomo, false);
  document.body.addEventListener('dragenter', want, false);
  document.body.addEventListener('dragover', want, false);
  document.body.addEventListener('drop', drop, false);
  
  load('sf.png');
}

function load(src, blob) {
  var image = new Image;
  image.onload = function() {
    draw(this);
    if (window.revokeBlobURL)
      window.revokeBlobURL(this.src);
  };
  image.src = src;
}

function draw(image) {
  var canvas = document.getElementById('canvas');
  canvas.width = image.naturalWidth;
  canvas.height = image.naturalHeight;
  if (canvas.width > innerWidth) {
    canvas.height *= innerWidth / canvas.width;
    canvas.width = innerWidth;
  }
  if (canvas.height > innerHeight) {
    canvas.width *= innerHeight / canvas.height;
    canvas.height = innerHeight;
  }
  var context = canvas.getContext('2d');
  context.drawImage(image, 0, 0, canvas.width, canvas.height);
  canvas.image = image;
  canvas.lomo = false;
}

function lomo(event) {
  var canvas = document.getElementById('canvas');
  if (!canvas.image)
    return;

  var context = canvas.getContext('2d');
  context.drawImage(canvas.image, 0, 0, canvas.width, canvas.height);

  canvas.lomo = !canvas.lomo;
  // XXX hack for vignette
  canvas.style.backgroundColor = canvas.lomo ? '#000' : '';
  if (!canvas.lomo)
    return;

  var pxls = context.getImageData(0, 0, canvas.width, canvas.height);
  
  // apply basic filters
  ProcessImageData(pxls, { contrast: 1.2, saturation: 1.2, temperature: 200 });

  // so-so vignette
  var row, col;
  var w = canvas.width, h = canvas.height;
  var x = event.clientX - canvas.offsetLeft;
  var y = event.clientY - canvas.offsetTop;
  x = (x - w / 2) / 16 + w / 2;
  y = (y - h / 2) / 16 + h / 2;
  for (row = 0; row < h; row++) {
    for (col = 0; col < w; col++) {
      pxls.data[(row * w + col) * 4 + 3] =
        (1 - Math.pow((col - x) / w * 2, 4)) *
        (1 - Math.pow((row - y) / h * 2, 4)) *
        255 + 16;
    }
  }
  
  context.putImageData(pxls, 0, 0);
}

function want(event) {
  //event.dataTransfer.dropEffect = 'copy';
  event.preventDefault();
}

function drop(event) {
  event.preventDefault();

  var data = event.dataTransfer;
  if (!data || !data.files.length)
    return;

  var file = data.files[0];
  if (!file)
    return;
  if (file.size > MAX_FILE_SIZE)
    return alert('File cannot be larger than 2 MB!');
  if (!~['image/jpeg', 'image/png', 'image/gif'].indexOf(file.type))
    return alert('File must be an image!');
  if (window.createBlobURL)
    load(window.createBlobURL(file));
  else if (window.FileReader) {
    var reader = new FileReader();
    reader.onload = function() {
      load(this.result);
    };
    reader.readAsDataURL(file);
  }
}

window.addEventListener('load', init, false);
</script>
</head>
<body>
<noscript>
  For full functionality of this site, it is necessary to enable JavaScript.
  Here are the <a href="http://enable-javascript.com" target="_blank">
  instructions on how to enable JavaScript in your web browser</a>.
</noscript>
<canvas id="canvas"></canvas>
<div></div>
</body>
</html>
